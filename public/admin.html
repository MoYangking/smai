<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SMAI 控制台</title>
  <style>
    :root {
      --bg: #f8fafc;
      --bg-subtle: #f9fafb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: rgba(16,185,129,0.25);      /* emerald 20-30% */
      --border-strong: rgba(16,185,129,0.45);
      --primary: #10b981;                   /* emerald */
      --violet: #8b5cf6;                    /* accent */
      --coral: #f97316;                     /* accent */
      --rose: #f43f5e;                      /* err */
      --ok: #16a34a;
      --warn: #f59e0b;
      --radius: 14px;
      --shadow-1: 0 2px 8px rgba(2, 6, 23, 0.05);
      --shadow-2: 0 8px 24px rgba(2, 6, 23, 0.08);
      --shadow-3: 0 16px 40px rgba(2, 6, 23, 0.12);
      --grid-dot: rgba(2, 6, 23, 0.04);
      --transition: cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background: var(--bg);
      overflow-y: auto;
    }

    /* soft background decorations */
    .bg-decor {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background-image:
        radial-gradient(1200px 600px at 10% -10%, rgba(139,92,246,0.12), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(16,185,129,0.12), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(249,115,22,0.10), transparent 60%),
        linear-gradient(transparent, transparent),
        radial-gradient(circle at 1px 1px, var(--grid-dot) 1px, transparent 0);
      background-size: auto, auto, auto, auto, 22px 22px;
      filter: blur(0.00001px); /* keep subpixel grid subtle */
      opacity: 1;
    }

    header {
      position: relative; z-index: 1;
      background: linear-gradient(to bottom, #ffffff, transparent);
      border-bottom: 1px solid rgba(15,23,42,0.06);
    }
    .header-wrap {
      max-width: 1200px; margin: 0 auto; padding: 20px 16px;
      display: flex; align-items: center; justify-content: space-between;
      animation: fadeInDown 0.7s var(--transition) both;
    }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand .logo {
      width: 36px; height: 36px; border-radius: 9px;
      background: rgba(16,185,129,0.12);
      border: 1px solid var(--border);
      display:flex; align-items:center; justify-content:center;
    }
    .brand .logo svg { stroke: var(--primary); }
    .brand .title { font-weight: 700; font-size: 18px; letter-spacing: .2px; }
    .brand .sub { color: var(--muted); font-size: 12px; }
    nav { display:flex; gap: 16px; }
    nav a { color: var(--muted); text-decoration: none; font-size: 14px; padding: 8px 10px; border-radius: 8px; transition: color .25s var(--transition), background-color .25s var(--transition); }
    nav a:hover, nav a:focus { color: var(--text); background: rgba(15,23,42,0.04); outline:none; }

    main { position: relative; z-index: 1; }
    .layout { max-width: 1200px; margin: 0 auto; padding: 20px 16px 56px; display: grid; gap: 20px; grid-template-columns: 1fr; }
    @media (min-width: 1024px) { .layout { grid-template-columns: 2fr 1fr; } }
    @media (min-width: 1440px) { .layout { grid-template-columns: 3fr 1.2fr; } }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-1);
      transition: transform .25s var(--transition), box-shadow .25s var(--transition), border-color .25s var(--transition), background-color .25s var(--transition);
      padding: 18px;
      animation: fadeInUp 0.75s var(--transition) both;
    }
    .card:hover { transform: translateY(-3px); box-shadow: var(--shadow-2); border-color: var(--border-strong); background-color: #ffffff; }
    .card .head { display:flex; gap:12px; align-items:center; margin-bottom: 10px; }
    .icon {
      width: 40px; height: 40px; border-radius: 10px;
      background: rgba(16,185,129,0.12); display:flex; align-items:center; justify-content:center;
      border: 1px solid var(--border);
    }
    .icon svg { width: 24px; height:24px; stroke: var(--primary); stroke-width: 2; }
    .head .title { font-weight: 600; font-size: 16px; }
    .head .desc { color: var(--muted); font-size: 13px; line-height: 1.6; margin-top: 4px; }

    .grid { display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 768px) { .grid.two { grid-template-columns: 1fr 1fr; } }

    .field { display:flex; flex-direction: column; gap:6px; }
    label { color: var(--muted); font-size: 12px; }
    input[type=text], textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(2,6,23,0.12);
      background: #fff; color: var(--text); outline: none; transition: border-color .2s var(--transition), box-shadow .2s var(--transition);
    }
    textarea { min-height: 120px; resize: vertical; }
    input[type=checkbox] { width: 18px; height: 18px; }
    input:focus, textarea:focus { border-color: rgba(16,185,129,0.5); box-shadow: 0 0 0 4px rgba(16,185,129,0.15); }

    .actions { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    button { padding: 10px 14px; border: 1px solid rgba(2,6,23,0.12); border-radius: 10px; background: #fff; color: var(--text); cursor: pointer; transition: transform .2s var(--transition), background-color .2s var(--transition), border-color .2s var(--transition), color .2s var(--transition); }
    button.primary { background: #10b981; color: #fff; border-color: #10b981; }
    button.secondary { background: #fff; color: var(--text); }
    button.ghost { background: #fff; }
    button:hover { transform: translateY(-2px); box-shadow: var(--shadow-2); }
    button:active { transform: scale(0.97); }
    button:focus { outline: none; box-shadow: 0 0 0 4px rgba(16,185,129,0.15); }

    .status { font-size: 13px; }
    .ok { color: var(--ok); }
    .err { color: var(--rose); }

    .stats { display:flex; gap: 10px; flex-wrap: wrap; }
    .stat { min-width: 140px; padding: 10px 12px; background: var(--bg-subtle); border: 1px solid rgba(2,6,23,0.06); border-radius: 10px; }
    .stat .k { font-size: 12px; color: var(--muted); }
    .stat .v { font-size: 18px; font-weight: 700; }

    .list { max-height: 260px; overflow: auto; border: 1px dashed rgba(2,6,23,0.18); border-radius: 10px; padding: 8px; background: #fff; }
    .pill { display: inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(2,6,23,0.18); margin: 4px 6px 0 0; font-size: 12px; color: var(--muted); background: #fff; }
    .pill .dot { width:6px; height:6px; border-radius:50%; background: var(--primary); opacity:.6; }

    aside .card { animation: fadeIn .7s var(--transition) .5s both; }
    .aside-links { display:flex; flex-direction: column; gap:6px; }
    .aside-links a { color: var(--muted); text-decoration: none; font-size: 14px; padding: 6px 8px; border-radius: 8px; transition: color .2s var(--transition), background-color .2s var(--transition); }
    .aside-links a:hover, .aside-links a:focus { color: var(--text); background: rgba(15,23,42,0.04); outline:none; }

    /* animations */
    @keyframes fadeInDown { from { opacity:0; transform: translateY(-8px); } to { opacity:1; transform:none; } }
    @keyframes fadeInUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform:none; } }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  </style>
  <script>
    async function api(path, opts={}){
      const r = await fetch(path, {headers:{'content-type':'application/json'}, ...opts});
      return await r.json();
    }
    function setStatus(id, msg, isErr=false){
      const el=document.getElementById(id); el.textContent=msg; el.className='status '+(isErr?'err':'ok');
      setTimeout(()=>{el.textContent='';}, 2800);
    }
    function setStat(id, val){
      const el=document.getElementById(id); if (el) el.textContent = String(val);
    }
    // Cookies list helpers
    let cookiesArr = [];
    function renderCookiesList(){
      const ul = document.getElementById('cookies-list');
      if (!ul) return;
      ul.innerHTML='';
      (cookiesArr||[]).forEach((ck,i)=>{
        const s=document.createElement('span');
        s.className='pill'; s.id='cookie-pill-'+i;
        const txt=String(ck||''); const shown = txt.length>60 ? (txt.slice(0,57)+'...') : txt;
        s.innerHTML='<span class="dot"></span>'+shown; ul.appendChild(s);
      });
    }
    function syncTextareaFromArray(){
      const v=(cookiesArr||[]).join('\n');
      const t=document.getElementById('cookies-input'); if(t) t.value=v;
      const h=document.getElementById('cookies'); if(h) h.value=v;
      setStat('cookies-count',(cookiesArr||[]).length);
    }
    function onAddCookie(){
      const el=document.getElementById('cookie-new');
      const v=(el&&el.value||'').trim();
      if(!v){ setStatus('cookies-status','请输入 Cookie', true); return; }
      if(!Array.isArray(cookiesArr)) cookiesArr=[];
      cookiesArr.push(v);
      if(el) el.value='';
      syncTextareaFromArray();
      renderCookiesList();
      setStatus('cookies-status','已添加到列表');
    }
    async function onTestCookies(){
      try{
        const list=(Array.isArray(cookiesArr)&&cookiesArr.length)?cookiesArr:(document.getElementById('cookies-input').value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if(!list.length){ setStatus('cookies-status','无可检测的 Cookies', true); return; }
        const r=await api('/admin/cookies/test',{method:'POST',body:JSON.stringify({cookies:list})});
        const results=Array.isArray(r.results)?r.results:[];
        let okCount=0;
        list.forEach((_,i)=>{ const pill=document.getElementById('cookie-pill-'+i); if(pill){ pill.style.borderColor=''; const dot=pill.querySelector('.dot'); if(dot) dot.style.background='var(--primary)'; } });
        results.forEach((it,i)=>{ const pill=document.getElementById('cookie-pill-'+i); if(!pill) return; if(it.ok){ okCount++; pill.style.borderColor='rgba(22,163,74,0.45)'; const dot=pill.querySelector('.dot'); if(dot) dot.style.background='#16a34a'; } else { pill.style.borderColor='rgba(244,63,94,0.45)'; const dot=pill.querySelector('.dot'); if(dot) dot.style.background='#f43f5e'; } });
        setStatus('cookies-status',`已检测 ${list.length} 条，OK ${okCount}/${list.length}`);
      }catch(e){ setStatus('cookies-status','检测失败', true); }
    }
    async function load(){
      try{
        const ms = await api('/v1/models');
        const list = (ms && ms.data) ? ms.data : [];
        setStat('models-count', list.length);
        const ul = document.getElementById('models-list'); ul.innerHTML='';
        list.slice(0, 120).forEach(x=>{ const s=document.createElement('span'); s.className='pill'; s.innerHTML='<span class="dot"></span>'+x.id; ul.appendChild(s); });
        setStat('last-refresh', new Date().toLocaleString());
      }catch(e){ setStatus('models-status', '获取模型失败', true); }
      try{
        const ck = await api('/admin/cookies');
        const arr = Array.isArray(ck.cookies) ? ck.cookies : [];
        document.getElementById('cookies').value = arr.join('\n');
        setStat('cookies-count', arr.length);
        cookiesArr = arr; syncTextareaFromArray(); renderCookiesList();
      }catch(e){ setStatus('cookies-status', '读取 Cookies 失败', true); }
    }
    async function onSaveCookies(){
      const cookies = document.getElementById('cookies').value.trim();
      const r = await api('/admin/cookies',{method:'POST',body:JSON.stringify({cookies})});
      setStatus('cookies-status', r.ok?('已保存，多条：'+r.count):'保存失败', !r.ok);
      if (r.ok) setStat('cookies-count', r.count||0);
    }
    async function onRefresh(){
      setStatus('models-status','刷新中...');
      const r = await api('/v1/models/refresh',{method:'POST'});
      setStatus('models-status', r && r.data ? '刷新成功' : '刷新失败', !(r&&r.data));
      await load();
    }
    async function onAddModel(){
      const id = document.getElementById('model-id').value.trim();
      const owned_by = document.getElementById('model-owned').value.trim() || 'custom';
      const supportsReasoning = document.getElementById('model-reason').checked;
      if(!id){ setStatus('models-status','请输入 Model ID', true); return; }
      const r = await api('/admin/models/add',{method:'POST',body:JSON.stringify({id,owned_by,supportsReasoning})});
      setStatus('models-status', r.ok?('已添加，合计 '+r.count):'添加失败', !r.ok);
      if (r.ok) { document.getElementById('model-id').value=''; await load(); }
    }
    async function onClear(){
      const r = await api('/admin/models/clear',{method:'POST'});
      setStatus('models-status', r.ok?'已清空缓存':'操作失败', !r.ok);
      await load();
    }
    window.addEventListener('DOMContentLoaded', load);
  </script>
</head>
<body>
  <div class="bg-decor" aria-hidden="true"></div>
  <header>
    <div class="header-wrap">
      <div class="brand" role="banner">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M4 12h6m4 0h6M12 4v6m0 4v6"/>
          </svg>
        </div>
        <div>
          <div class="title">SMAI 控制台</div>
          <div class="sub">OpenAI 兼容网关 · smithery.ai 代理</div>
        </div>
      </div>
      <nav aria-label="快速导航">
        <a href="#cookies">Cookies</a>
        <a href="#models">模型</a>
        <a href="#add">添加模型</a>
        <a href="#help">帮助</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="layout">
      <section class="main">
        <!-- Cookies 管理 -->
        <div class="card" id="cookies-card">
          <div class="head">
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M4 12a8 8 0 1 1 8 8M8 12h.01M12 8h.01M12 16h.01M16 12h.01"/></svg>
            </div>
            <div>
              <div class="title" id="cookies">Cookies 管理（支持多行轮询）</div>
              <div class="desc">为 smithery.ai 配置多组认证 Cookie。每行填写一条完整 Cookie 串，系统会按顺序轮询使用，提高稳定性与并发能力。保存后立即生效。</div>
            </div>
          </div>
          <div class="grid">
            <div class="stats">
              <div class="stat"><div class="k">已配置 Cookies 数</div><div class="v" id="cookies-count">0</div></div>
              <div class="stat"><div class="k">状态</div><div class="v"><span id="cookies-status" class="status"></span></div></div>
            </div>
            <div class="field">
              <label for="cookie-new">添加单条 Cookie</label>
              <input id="cookie-new" type="text" placeholder="例如：k1=v1; k2=v2" />
            </div>
            <div class="actions">
              <button class="primary" aria-label="添加 Cookie" onclick="onAddCookie()">添加到列表</button>
              <button class="secondary" aria-label="检测 Cookies" onclick="onTestCookies()">检测 Cookies（gemini-2.5-flash-lite）</button>
            </div>
            <div class="field" aria-label="Cookies 多行输入">
              <label for="cookies-input">每行一个完整 Cookie 串（示例：k1=v1; k2=v2）</label>
              <textarea id="cookies-input" placeholder="每行一个 smithery.ai 所需 Cookie"></textarea>
            </div>
            <div class="actions">
              <button class="primary" aria-label="保存 Cookies" onclick="(function(){ const v=document.getElementById('cookies-input').value; document.getElementById('cookies').value=v; onSaveCookies(); })()">保存 Cookies</button>
              <button class="secondary" aria-label="清空输入" onclick="document.getElementById('cookies-input').value='';">清空</button>
            </div>
            <div class="list" id="cookies-list" aria-label="Cookies 列表"></div>
          </div>
        </div>

        <!-- 模型缓存 -->
        <div class="card" id="models-card">
          <div class="head">
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
            </div>
            <div>
              <div class="title" id="models">模型缓存</div>
              <div class="desc">系统会定期抓取 smithery.ai 的模型清单以便客户端快速查询。您也可以手动刷新或清空本地缓存，确保接口响应及时、数据可靠。</div>
            </div>
          </div>
          <div class="grid">
            <div class="stats">
              <div class="stat"><div class="k">模型数量</div><div class="v" id="models-count">0</div></div>
              <div class="stat"><div class="k">最近操作</div><div class="v" id="last-refresh">—</div></div>
              <div class="stat"><div class="k">状态</div><div class="v"><span id="models-status" class="status"></span></div></div>
            </div>
            <div class="actions">
              <button class="primary" aria-label="刷新模型" onclick="onRefresh()">在线刷新模型</button>
              <button class="secondary" aria-label="清空缓存" onclick="onClear()">清空缓存</button>
            </div>
            <div class="list" id="models-list" aria-label="模型列表（前120条）"></div>
          </div>
        </div>

        <!-- 手动添加模型 -->
        <div class="card" id="add-card">
          <div class="head">
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 5v14M5 12h14"/></svg>
            </div>
            <div>
              <div class="title" id="add">手动添加模型</div>
              <div class="desc">当目标站点结构更新、解析暂不可用时，可手动添加模型条目以保障服务正常使用。可选择生成推理衍生后缀，便于客户端快速匹配。</div>
            </div>
          </div>
          <div class="grid two">
            <div class="field">
              <label for="model-id">Model ID</label>
              <input id="model-id" type="text" placeholder="例如：gpt-5-mini" />
            </div>
            <div class="field">
              <label for="model-owned">Owned By</label>
              <input id="model-owned" type="text" placeholder="例如：openai" />
            </div>
            <div class="field" style="align-items:flex-start; gap:10px; flex-direction:row;">
              <input id="model-reason" type="checkbox" aria-label="支持推理" />
              <label for="model-reason">支持推理（生成 -minimal/-low/-medium/-high 衍生）</label>
            </div>
            <div class="actions">
              <button class="primary" aria-label="添加模型" onclick="onAddModel()">添加模型</button>
            </div>
          </div>
        </div>
      </section>

      <aside>
        <!-- 快速导航与说明 -->
        <div class="card">
          <div class="head">
            <div class="icon" style="background: rgba(139,92,246,0.12); border-color: rgba(139,92,246,0.25);">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="stroke: var(--violet)"><path d="M12 6v12M6 12h12"/></svg>
            </div>
            <div>
              <div class="title">快速导航</div>
              <div class="desc">直接跳转到页面关键区域，便于快速操作与复核设置，降低错误率并提升效率。</div>
            </div>
          </div>
          <div class="aside-links" aria-label="侧边导航链接">
            <a href="#cookies">Cookies 管理</a>
            <a href="#models">模型缓存</a>
            <a href="#add">手动添加模型</a>
            <a href="#help">帮助与说明</a>
          </div>
        </div>

        <div class="card" id="help">
          <div class="head">
            <div class="icon" style="background: rgba(244,63,94,0.12); border-color: rgba(244,63,94,0.25);">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="stroke: var(--rose)"><path d="M12 9v2m0 4h.01M12 5a7 7 0 1 1 0 14a7 7 0 0 1 0-14z"/></svg>
            </div>
            <div>
              <div class="title">帮助与说明</div>
              <div class="desc">使用多行 Cookies 轮询可提高并发稳定性；建议定期刷新模型缓存以保证列表覆盖最新变更，必要时使用手动添加保障业务连续性。</div>
            </div>
          </div>
          <ul style="margin:0; padding-left:18px; color: var(--muted); line-height:1.8;">
            <li>每行填写一条完整 Cookie 串，例如：<code>k1=v1; k2=v2</code></li>
            <li>模型列表最多展示前 120 条，可在客户端进行筛选</li>
            <li>重要操作均带有明确的状态反馈与动画提示</li>
            <li>所有交互元素支持键盘导航与焦点高亮</li>
          </ul>
          <div style="height:10px"></div>
          <div class="aside-links">
            <a href="https://smithery.ai" target="_blank" rel="noopener">smithery.ai</a>
            <a href="#models" onclick="onRefresh()">立即刷新模型</a>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- hidden mirrors for script compatibility -->
  <textarea id="cookies" style="display:none"></textarea>
</body>
</html>
